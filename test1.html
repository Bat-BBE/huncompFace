<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Face Assistant</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
  body{background:linear-gradient(135deg,#6e8efb,#a777e3);min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;}
  .container{max-width:1100px;width:100%;background:rgba(255,255,255,0.95);color:#333;border-radius:15px;padding:20px;margin:20px;}
  header{text-align:center;padding:15px;background:linear-gradient(to right,#6e8efb,#a777e3);color:white;border-radius:15px;}
  h1{font-size:2rem;}
  .main{display:flex;flex-wrap:wrap;gap:20px;margin-top:20px;}
  .video-container{flex:1;min-width:320px;position:relative;border-radius:10px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,0.2);}
  #video{width:100%;transform:scaleX(-1);}
  #overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}
  .loading{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:white;border-radius:10px;z-index:10;}
  .controls{flex:1;min-width:300px;display:flex;flex-direction:column;gap:15px;}
  button{padding:10px 15px;border:none;border-radius:50px;background:linear-gradient(to right,#6e8efb,#a777e3);color:white;font-weight:bold;cursor:pointer;transition:0.3s;}
  button:hover{transform:translateY(-2px);}
  .advice-box,.user-box{padding:15px;background:#f0f0f0;border-radius:10px;min-height:100px;color:#333;overflow-y:auto;}
  .user-box img{width:70px;height:70px;border-radius:50%;margin-right:10px;object-fit:cover;}
  .user-info{display:flex;align-items:center;margin-bottom:10px;}
  .recommendation{background-color:#e6f7ff;padding:10px;border-radius:8px;margin-top:10px;border-left:4px solid #1890ff;}
  .login-form{display:none;background:rgba(255,255,255,0.9);padding:20px;border-radius:10px;margin-top:15px;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
  .login-form input{width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:5px;}
  .login-form button{margin-top:10px;}
  .user-preferences{display:none;margin-top:15px;padding:15px;background:#f9f9f9;border-radius:10px;}
  .preference-item{margin-bottom:10px;}
  .preference-item label{display:block;margin-bottom:5px;font-weight:bold;}
  .preference-item select{width:100%;padding:8px;border-radius:5px;border:1px solid #ddd;}
  .emotion-history{display:none;margin-top:15px;padding:15px;background:#f9f9f9;border-radius:10px;}
  .emotion-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #eee;}
  @media(max-width:768px){.main{flex-direction:column;}}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ü§ñ Smart Face Assistant</h1>
    <p>–ù“Ø“Ø—Ä—ç—ç —Ç–∞–Ω–∏–ª—Ü—É—É–ª–∂, —Å—ç—Ç–≥—ç–ª —Ö”©–¥–ª”©–ª + —Ö—É–≤–∏–π–Ω –∑”©–≤–ª”©–≥”©”©–≥ —Ö–æ—Å–ª—É—É–ª—Å–∞–Ω —É—Ö–∞–∞–ª–∞–≥ —Ç—É—Å–ª–∞—Ö</p>
  </header>

  <div class="main">
    <div class="video-container">
      <video id="video" autoplay muted></video>
      <canvas id="overlay"></canvas>
      <div class="loading" id="loading">–ú–æ–¥–µ–ª –±–æ–ª–æ–Ω –∫–∞–º–µ—Ä–∏–π–≥ –∞—á–∞–∞–ª–∂ –±–∞–π–Ω–∞...</div>
    </div>

    <div class="controls">
      <div class="login-form" id="loginForm">
        <h3>–ù—ç–≤—Ç—Ä—ç—Ö / –ë“Ø—Ä—Ç–≥“Ø“Ø–ª—ç—Ö</h3>
        <input type="text" id="usernameInput" placeholder="–•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –Ω—ç—Ä">
        <input type="password" id="passwordInput" placeholder="–ù—É—É—Ü “Ø–≥">
        <button id="loginBtn">–ù—ç–≤—Ç—Ä—ç—Ö</button>
        <button id="registerBtn">–ë“Ø—Ä—Ç–≥“Ø“Ø–ª—ç—Ö</button>
      </div>

      <div class="user-box" id="userBox">
        <div id="userInfo">–¢–∞–Ω–∏–≥–¥—Å–∞–Ω —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª —ç–Ω–¥ –≥–∞—Ä–Ω–∞</div>
        <button id="logoutBtn" style="display:none; margin-top:10px;">–ì–∞—Ä–∞—Ö</button>
        <button id="preferencesBtn" style="display:none; margin-top:10px;">–¢–æ—Ö–∏—Ä–≥–æ–æ</button>
      </div>

      <div class="user-preferences" id="userPreferences">
        <h3>–•—É–≤–∏–π–Ω —Ç–æ—Ö–∏—Ä–≥–æ–æ</h3>
        <div class="preference-item">
          <label for="musicPreference">–î—É—É–Ω—ã —Å–æ–Ω–≥–æ–ª—Ç:</label>
          <select id="musicPreference">
            <option value="relaxing">–¢–∞–π–≤—à—Ä—É—É–ª–∞—Ö</option>
            <option value="energetic">–≠—Ä—á —Ö“Ø—á—Ç—ç–π</option>
            <option value="focus">–¢”©–≤–ª”©—Ä”©–ª</option>
            <option value="happy">–ñ–∞—Ä–≥–∞–ª—Ç–∞–π</option>
          </select>
        </div>
        <div class="preference-item">
          <label for="adviceType">–ó”©–≤–ª”©–≥”©”©–Ω–∏–π —Ç”©—Ä”©–ª:</label>
          <select id="adviceType">
            <option value="motivational">–£—Ä–∞–º –∑–æ—Ä–∏–≥</option>
            <option value="practical">–ü—Ä–∞–∫—Ç–∏–∫</option>
            <option value="emotional">–°—ç—Ç–≥—ç–ª —Ö”©–¥–ª”©–ª</option>
          </select>
        </div>
        <button id="savePreferencesBtn">–¢–æ—Ö–∏—Ä–≥–æ–æ–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö</button>
      </div>

      <button id="recognizeBtn" style="display:none;">üîç –¢–∞–Ω–∏—Ö</button>
      <button id="screenshotBtn" style="display:none;">üì∏ –ó—É—Ä–∞–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö</button>

      <div class="advice-box" id="adviceBox">–°—ç—Ç–≥—ç–ª —Ö”©–¥–ª”©–ª–∏–π–Ω –∑”©–≤–ª”©–≥”©”© —ç–Ω–¥ –≥–∞—Ä–Ω–∞</div>
      
      <div class="emotion-history" id="emotionHistory">
        <h3>–°—ç—Ç–≥—ç–ª —Ö”©–¥–ª”©–ª–∏–π–Ω —Ç“Ø“Ø—Ö</h3>
        <div id="emotionList"></div>
      </div>
    </div>
  </div>
</div>

<script>
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const loading = document.getElementById('loading');
const loginForm = document.getElementById('loginForm');
const usernameInput = document.getElementById('usernameInput');
const passwordInput = document.getElementById('passwordInput');
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const recognizeBtn = document.getElementById('recognizeBtn');
const screenshotBtn = document.getElementById('screenshotBtn');
const userBox = document.getElementById('userBox');
const userInfo = document.getElementById('userInfo');
const logoutBtn = document.getElementById('logoutBtn');
const preferencesBtn = document.getElementById('preferencesBtn');
const userPreferences = document.getElementById('userPreferences');
const musicPreference = document.getElementById('musicPreference');
const adviceType = document.getElementById('adviceType');
const savePreferencesBtn = document.getElementById('savePreferencesBtn');
const adviceBox = document.getElementById('adviceBox');
const emotionHistory = document.getElementById('emotionHistory');
const emotionList = document.getElementById('emotionList');

let labeledDescriptors = [];
let currentUser = null;
let isRunning = true;
let userData = JSON.parse(localStorage.getItem('faceAssistantUsers')) || {};
let emotionHistoryData = JSON.parse(localStorage.getItem('emotionHistory')) || {};

async function startVideo() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
    video.srcObject = stream;
    video.addEventListener('loadeddata', () => loading.style.display = 'none');
  } catch(err) {
    loading.textContent = '–ö–∞–º–µ—Ä –æ–ª–¥—Å–æ–Ω–≥“Ø–π: ' + err.message;
  }
}

async function loadModels() {
  const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
    faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
  ]);
  startVideo();
}

window.onload = function() {
  loginForm.style.display = 'block';
};

loginBtn.addEventListener('click', function() {
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();
  
  if (!username || !password) {
    alert("–ù—ç—Ä –±–æ–ª–æ–Ω –Ω—É—É—Ü “Ø–≥—ç—ç –æ—Ä—É—É–ª–Ω–∞ —É—É!");
    return;
  }
  
  if (userData[username] && userData[username].password === password) {
    currentUser = username;
    loginForm.style.display = 'none';
    recognizeBtn.style.display = 'block';
    screenshotBtn.style.display = 'block';
    logoutBtn.style.display = 'block';
    preferencesBtn.style.display = 'block';
    emotionHistory.style.display = 'block';
    
    userInfo.innerHTML = `
      <div class="user-info">
        <img src="https://ui-avatars.com/api/?name=${username}" alt="${username}">
        <div>
          <strong>${username}</strong><br>
          –ê–º–∂–∏–ª—Ç—Ç–∞–π –Ω—ç–≤—Ç—ç—Ä–ª—ç—ç ‚úÖ
        </div>
      </div>
    `;
    
    if (userData[username].preferences) {
      musicPreference.value = userData[username].preferences.music || 'relaxing';
      adviceType.value = userData[username].preferences.advice || 'motivational';
    }
    
    updateEmotionHistory();
    
    alert(`–¢–∞–≤—Ç–∞–π –º–æ—Ä–∏–ª, ${username}!`);
  } else {
    alert("–ù—ç—Ä —ç—Å–≤—ç–ª –Ω—É—É—Ü “Ø–≥ –±—É—Ä—É—É –±–∞–π–Ω–∞!");
  }
});

registerBtn.addEventListener('click', async function() {
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();
  
  if (!username || !password) {
    alert("–ù—ç—Ä –±–æ–ª–æ–Ω –Ω—É—É—Ü “Ø–≥—ç—ç –æ—Ä—É—É–ª–Ω–∞ —É—É!");
    return;
  }
  
  if (userData[username]) {
    alert("–≠–Ω—ç —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –Ω—ç—Ä –∞–ª—å —Ö—ç–¥–∏–π–Ω –±“Ø—Ä—Ç–≥—ç–≥–¥—Å—ç–Ω –±–∞–π–Ω–∞!");
    return;
  }

  const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
    .withFaceLandmarks()
    .withFaceDescriptor();
  
  if (!detections) {
    alert("–ù“Ø“Ø—Ä –∏–ª—Ä—ç—ç–≥“Ø–π. –ö–∞–º–µ—Ä —Ä—É—É —Ö–∞—Ä–Ω–∞ —É—É!");
    return;
  }

  userData[username] = {
    password: password,
    faceDescriptor: Array.from(detections.descriptor),
    preferences: {
      music: 'relaxing',
      advice: 'motivational'
    },
    registeredAt: new Date().toISOString()
  };
  
  localStorage.setItem('faceAssistantUsers', JSON.stringify(userData));
  
  alert(`${username} —Ö—ç—Ä—ç–≥–ª—ç–≥—á –∞–º–∂–∏–ª—Ç—Ç–∞–π –±“Ø—Ä—Ç–≥—ç–≥–¥–ª—ç—ç! –û–¥–æ–æ –Ω—ç–≤—Ç—Ä—ç—Ö –±–æ–ª–æ–º–∂—Ç–æ–π.`);
});

logoutBtn.addEventListener('click', function() {
  currentUser = null;
  loginForm.style.display = 'block';
  recognizeBtn.style.display = 'none';
  screenshotBtn.style.display = 'none';
  logoutBtn.style.display = 'none';
  preferencesBtn.style.display = 'none';
  userPreferences.style.display = 'none';
  emotionHistory.style.display = 'none';
  userInfo.innerHTML = '–¢–∞–Ω–∏–≥–¥—Å–∞–Ω —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª —ç–Ω–¥ –≥–∞—Ä–Ω–∞';
  adviceBox.innerHTML = '–°—ç—Ç–≥—ç–ª —Ö”©–¥–ª”©–ª–∏–π–Ω –∑”©–≤–ª”©–≥”©”© —ç–Ω–¥ –≥–∞—Ä–Ω–∞';
  usernameInput.value = '';
  passwordInput.value = '';
});

preferencesBtn.addEventListener('click', function() {
  userPreferences.style.display = userPreferences.style.display === 'block' ? 'none' : 'block';
});

savePreferencesBtn.addEventListener('click', function() {
  if (currentUser) {
    userData[currentUser].preferences = {
      music: musicPreference.value,
      advice: adviceType.value
    };
    localStorage.setItem('faceAssistantUsers', JSON.stringify(userData));
    alert("–¢–æ—Ö–∏—Ä–≥–æ–æ –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞!");
    userPreferences.style.display = 'none';
  }
});

function getEmojiAdvice(expressions, username) {
  const maxExp = Object.keys(expressions).reduce((a, b) => expressions[a] > expressions[b] ? a : b);
  const userPrefs = userData[username]?.preferences || { music: 'relaxing', advice: 'motivational' };
  
  let emoji, advice, music;
  
  switch(maxExp) {
    case 'happy':
      emoji = 'üòä';
      advice = '–¢–∞ –±–∞—è—Ä—Ç–∞–π –±–∞–π–Ω–∞! –≠–Ω—ç —É—É—Ä –∞–º—å—Å–≥–∞–ª—ã–≥ —Ö–∞–¥–≥–∞–ª–∞–∞—Ä–∞–π :)';
      music = userPrefs.music === 'happy' ? '–ñ–∞—Ä–≥–∞–ª—Ç–∞–π –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç' : '–ï—Ä”©–Ω—Ö–∏–π –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç';
      break;
    case 'sad':
      emoji = 'üò¢';
      advice = '–ì—É–Ω–∏–≥ –º—ç–¥—ç—Ä—á –±–∞–π–Ω–∞. –ê–º—å—Å–≥–∞–∞ –∞–≤–∞–∞–¥ —Ç–∞–π–≤—à–∏—Ä, –±“Ø—Ö –∑“Ø–π–ª —Å–∞–π—Ö–∞–Ω –±–æ–ª–Ω–æ.';
      music = userPrefs.music === 'relaxing' ? '–¢–∞–π–≤—à—Ä—É—É–ª–∞—Ö –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç' : '–ï—Ä”©–Ω—Ö–∏–π –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç';
      break;
    case 'angry':
      emoji = 'üò°';
      advice = '–£—É—Ä —É—Ü–∞–∞—Ä—Ç–∞–π –±–∞–π–Ω–∞! –¢–∞–π–≤—à–∏—Ä—á, –∞–∞–∂—É—É—Ö–∞–Ω –±–æ–¥–æ—Ö —Ö—ç—Ä—ç–≥—Ç—ç–π.';
      music = userPrefs.music === 'relaxing' ? '–¢–∞–π–≤—à—Ä—É—É–ª–∞—Ö –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç' : '–ï—Ä”©–Ω—Ö–∏–π –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç';
      break;
    case 'surprised':
      emoji = 'üòÆ';
      advice = '–ì–∞–π—Ö—Å–∞–Ω –±–∞–π–Ω–∞! –ì–∞–π—Ö–ª—ã–≥ —ç–µ—Ä—ç–≥ —ç—Ä—á —Ö“Ø—á –±–æ–ª–≥–æ–Ω —Ö—É–≤–∏—Ä–≥–∞–∞—Ä–∞–π.';
      music = userPrefs.music === 'energetic' ? '–≠—Ä—á —Ö“Ø—á—Ç—ç–π –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç' : '–ï—Ä”©–Ω—Ö–∏–π –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç';
      break;
    case 'fearful':
      emoji = 'üò®';
      advice = '–ê–π–∂ –±–∞–π–Ω–∞. –ê–π–¥–∞—Å –±–æ–ª —Ö—ç–≤–∏–π–Ω –º—ç–¥—Ä—ç–º–∂, –≥—ç—Ö–¥—ç—ç —Ç“Ø“Ø–Ω–∏–π–≥ —É–¥–∏—Ä–¥–∞–∂ —Å—É—Ä.';
      music = userPrefs.music === 'relaxing' ? '–¢–∞–π–≤—à—Ä—É—É–ª–∞—Ö –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç' : '–ï—Ä”©–Ω—Ö–∏–π –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç';
      break;
    case 'disgusted':
      emoji = 'ü§¢';
      advice = '–≠–≤–≥“Ø–π –º—ç–¥—Ä—ç–º–∂—Ç—ç–π –±–∞–π–Ω–∞. –≠–Ω—ç –º—ç–¥—Ä—ç–º–∂ ”©–Ω–≥”©—Ä”©—Ö –±–æ–ª–Ω–æ.';
      music = userPrefs.music === 'focus' ? '–¢”©–≤–ª”©—Ä”©–ª –¥—ç–º–∂–∏—Ö –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç' : '–ï—Ä”©–Ω—Ö–∏–π –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç';
      break;
    default:
      emoji = 'üòê';
      advice = '–¢–∞–π–≤–∞–Ω –±–∞–π–Ω–∞! –≠–Ω—ç –±–æ–ª —Å–∞–π–Ω —à–∏–Ω–∂ ‚Äî —Ç”©–≤–ª”©—Ä”©–ª ”©–Ω–¥”©—Ä –±–∞–π–Ω–∞.';
      music = userPrefs.music === 'focus' ? '–¢”©–≤–ª”©—Ä”©–ª –¥—ç–º–∂–∏—Ö –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç' : '–ï—Ä”©–Ω—Ö–∏–π –¥—É—É–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç';
  }
  
  let specificAdvice = '';
  switch(userPrefs.advice) {
    case 'motivational':
      specificAdvice = '”®–Ω”©”©–¥”©—Ä ”©”©—Ä–∏–π–≥”©”© —É—Ä–∞–º—à—É—É–ª–∂, —à–∏–Ω—ç –∑“Ø–π–ª —Ç—É—Ä—à–∏–∂ “Ø–∑—ç—Ö—ç–¥ —Ç–æ—Ö–∏—Ä–æ–º–∂—Ç–æ–π ”©–¥”©—Ä!';
      break;
    case 'practical':
      specificAdvice = '”®–¥—Ä–∏–π–Ω —Ç”©–ª”©–≤–ª”©–≥”©”©–≥”©”© —Ö–∏–π–∂, “Ø—Ä –¥“Ø–Ω—Ç—ç–π –∞–∂–∏–ª–ª–∞—Ö —Ü–∞–≥ –±–æ–ª–∂ –±–∞–π–Ω–∞.';
      break;
    case 'emotional':
      specificAdvice = '–û–¥–æ–æ–≥–∏–π–Ω –º—ç–¥—Ä—ç–º–∂“Ø“Ø–¥—ç—ç —Ö“Ø–ª—ç—ç–Ω –∑”©–≤—à”©”©—Ä—á, —Ç—ç–¥–≥—ç—ç—Ä–∏–π–≥ –±–æ–ª–æ–≤—Å—Ä—É—É–ª–∞—Ö–∞–¥ —Ü–∞–≥ –≥–∞—Ä–≥–∞.';
      break;
  }
  
  return { emoji, advice, music, specificAdvice, emotion: maxExp };
}

recognizeBtn.addEventListener('click', async function() {
  if (!currentUser) {
    alert("–≠—Ö–ª—ç—ç–¥ –Ω—ç–≤—Ç—Ä—ç—Ö —Ö—ç—Ä—ç–≥—Ç—ç–π!");
    return;
  }

  const userDescriptors = [];
  for (const username in userData) {
    if (userData[username].faceDescriptor) {
      const descriptor = new Float32Array(userData[username].faceDescriptor);
      userDescriptors.push(new faceapi.LabeledFaceDescriptors(username, [descriptor]));
    }
  }
  
  if (userDescriptors.length === 0) {
    alert("–ë“Ø—Ä—Ç–≥—ç–ª—Ç—ç–π –Ω“Ø“Ø—Ä –∞–ª–≥–∞. –≠—Ö–ª—ç—ç–¥ –±“Ø—Ä—Ç–≥“Ø“Ø–ª–Ω—ç “Ø“Ø!");
    return;
  }
  
  const faceMatcher = new faceapi.FaceMatcher(userDescriptors, 0.6);
  const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
    .withFaceLandmarks()
    .withFaceDescriptor()
    .withFaceExpressions();
  
  if (!detections) {
    alert("–ù“Ø“Ø—Ä –∏–ª—Ä—ç—ç–≥“Ø–π!");
    return;
  }
  
  const bestMatch = faceMatcher.findBestMatch(detections.descriptor);
  const { emoji, advice, music, specificAdvice, emotion } = getEmojiAdvice(detections.expressions, bestMatch.label);

  userInfo.innerHTML = `
    <div class="user-info">
      <img src="https://ui-avatars.com/api/?name=${bestMatch.label}" alt="${bestMatch.label}">
      <div>
        <strong>${bestMatch.label}</strong><br>
        –¢–∞–Ω–∏–≥–¥—Å–∞–Ω –±–∞–π–Ω–∞ ‚úÖ<br>
        –°—ç—Ç–≥—ç–ª —Ö”©–¥–ª”©–ª: ${emoji} ${emotion}
      </div>
    </div>
  `;
  
  adviceBox.innerHTML = `
    ${emoji} ${advice}
    <div class="recommendation">
      <strong>–¢–∞–Ω–¥ –∑–æ—Ä–∏—É–ª—Å–∞–Ω —Å–∞–Ω–∞–ª:</strong><br>
      ${specificAdvice}<br>
      <strong>–î—É—É–Ω—ã —Å–∞–Ω–∞–ª:</strong> ${music}
    </div>
  `;

  if (!emotionHistoryData[currentUser]) {
    emotionHistoryData[currentUser] = [];
  }
  
  emotionHistoryData[currentUser].push({
    emotion: emotion,
    emoji: emoji,
    timestamp: new Date().toISOString(),
    confidence: Math.max(...Object.values(detections.expressions))
  });

  if (emotionHistoryData[currentUser].length > 10) {
    emotionHistoryData[currentUser].shift();
  }
  
  localStorage.setItem('emotionHistory', JSON.stringify(emotionHistoryData));
  updateEmotionHistory();
});

function updateEmotionHistory() {
  if (!currentUser || !emotionHistoryData[currentUser]) {
    emotionList.innerHTML = '<p>–¢“Ø“Ø—Ö —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞</p>';
    return;
  }
  
  let historyHTML = '';
  emotionHistoryData[currentUser].slice().reverse().forEach(entry => {
    const date = new Date(entry.timestamp);
    const timeString = `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
    historyHTML += `
      <div class="emotion-item">
        <span>${entry.emoji} ${entry.emotion}</span>
        <span>${timeString}</span>
      </div>
    `;
  });
  
  emotionList.innerHTML = historyHTML;
}

video.addEventListener('play', () => {
  overlay.width = video.videoWidth;
  overlay.height = video.videoHeight;
  const displaySize = { width: video.videoWidth, height: video.videoHeight };
  faceapi.matchDimensions(overlay, displaySize);

  async function detect() {
    if (!isRunning) return requestAnimationFrame(detect);
    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
      .withFaceLandmarks()
      .withFaceExpressions();
    const resized = faceapi.resizeResults(detections, displaySize);
    const ctx = overlay.getContext('2d');
    ctx.clearRect(0, 0, overlay.width, overlay.height);

    resized.forEach(det => {
      const { x, y, width, height } = det.detection.box;
      const maxExp = Object.keys(det.expressions).reduce((a, b) => 
        det.expressions[a] > det.expressions[b] ? a : b
      );
      
      let emoji;
      switch(maxExp) {
        case 'happy': emoji = 'üòä'; break;
        case 'sad': emoji = 'üò¢'; break;
        case 'angry': emoji = 'üò°'; break;
        case 'surprised': emoji = 'üòÆ'; break;
        case 'fearful': emoji = 'üò®'; break;
        case 'disgusted': emoji = 'ü§¢'; break;
        default: emoji = 'üòê';
      }
      
      ctx.font = `${Math.round(width * 0.8)}px Arial`;
      ctx.fillText(emoji, x, y + height / 1.2);
    });
    requestAnimationFrame(detect);
  }
  detect();
});

screenshotBtn.addEventListener('click', () => {
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = video.videoWidth;
  tempCanvas.height = video.videoHeight;
  const ctx = tempCanvas.getContext('2d');
  ctx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
  const link = document.createElement('a');
  link.href = tempCanvas.toDataURL('image/png');
  link.download = 'face.png';
  link.click();
});
loadModels();
</script>
</body>
</html>